name: Test Build (No Publish)

on:
  # Trigger on push to this branch for automatic testing
  push:
    branches:
      - copilot/duplicate-workflow-discard-artifacts
  
  # Manual trigger also available
  workflow_dispatch:

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run unit tests
        run: |
          python -m unittest discover -s tests -v

  build-linux:
    name: Build Linux ${{ matrix.arch }}
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, i686, arm64]
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch all tags
        run: git fetch --tags --force
      
      - name: Set up QEMU for ARM64 emulation
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64
      
      - name: Set up Docker Buildx
        if: matrix.arch == 'arm64' || matrix.arch == 'i686'
        uses: docker/setup-buildx-action@v3
      
      - name: Calculate version
        id: version
        shell: bash
        run: |
          # Use test version for test builds
          VERSION="test-$(date +%Y%m%d-%H%M%S)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Update version in files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python3 -c "
          import re
          version = '$VERSION'
          with open('chatrixcd/__init__.py', 'r') as f:
              content = f.read()
          content = re.sub(r'__version__ = \".*\"', f'__version__ = \"{version}\"', content)
          with open('chatrixcd/__init__.py', 'w') as f:
              f.write(content)
          print(f'Updated version to {version}')
          "
      
      - name: Build with Nuitka (x86_64)
        if: matrix.arch == 'x86_64'
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: chatrixcd/main.py
          mode: onefile
          output-file: chatrixcd-linux-x86_64
          enable-plugins: anti-bloat
          assume-yes-for-downloads: true
          linux-icon: assets/icon.png
          include-data-dir: assets=assets
      
      - name: Build with Nuitka (i686 - using Docker)
        if: matrix.arch == 'i686'
        run: |
          docker run --rm -v "$PWD":/src -w /src i386/python:3.12-slim sh -c "
          apt-get update && apt-get install -y gcc patchelf ccache &&
          pip install --upgrade pip &&
          pip install -r requirements.txt &&
          pip install nuitka ordered-set &&
          python -m nuitka --mode=onefile \
            --output-filename=chatrixcd-linux-i686 \
            --enable-plugin=anti-bloat \
            --assume-yes-for-downloads \
            --linux-icon=assets/icon.png \
            --include-data-dir=assets=assets \
            chatrixcd/main.py
          "
      
      - name: Build with Nuitka (arm64 - using Docker)
        if: matrix.arch == 'arm64'
        run: |
          docker run --rm --platform linux/arm64 -v "$PWD":/src -w /src arm64v8/python:3.12-slim sh -c "
          apt-get update && apt-get install -y gcc patchelf ccache &&
          pip install --upgrade pip &&
          pip install -r requirements.txt &&
          pip install nuitka ordered-set &&
          python -m nuitka --mode=onefile \
            --output-filename=chatrixcd-linux-arm64 \
            --enable-plugin=anti-bloat \
            --assume-yes-for-downloads \
            --linux-icon=assets/icon.png \
            --include-data-dir=assets=assets \
            chatrixcd/main.py
          "
      
      - name: Verify build and show evidence
        run: |
          BINARY="chatrixcd-linux-${{ matrix.arch }}"
          # For x86_64, Nuitka Action outputs to build/ directory
          if [ "${{ matrix.arch }}" = "x86_64" ] && [ -f "build/$BINARY" ]; then
            BINARY="build/$BINARY"
          fi
          
          if [ -f "$BINARY" ]; then
            echo "========================================="
            echo "✅ Build successful for Linux ${{ matrix.arch }}"
            echo "========================================="
            ls -lh "$BINARY"
            echo ""
            echo "SHA256 Checksum:"
            sha256sum "$BINARY"
            echo ""
            echo "File Size: $(stat -c%s "$BINARY") bytes ($(ls -lh "$BINARY" | awk '{print $5}'))"
            echo "========================================="
          else
            echo "❌ Build failed - binary not found"
            exit 1
          fi

  build-windows:
    name: Build Windows ${{ matrix.arch }}
    needs: test
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all tags
        run: git fetch --tags --force
      
      - name: Calculate version
        id: version
        shell: bash
        run: |
          # Use test version for test builds
          VERSION="test-$(date +%Y%m%d-%H%M%S)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Install libolm (Windows)
        shell: pwsh
        run: |
          # Download and build libolm (pinned to v3.2.16 for reproducible builds)
          git clone --branch 3.2.16 --depth 1 https://gitlab.matrix.org/matrix-org/olm.git C:\olm
          cd C:\olm
          
          # Patch CMakeLists.txt to require CMake 3.5+ (for compatibility with modern CMake)
          $originalContent = Get-Content CMakeLists.txt -Raw
          $patchedContent = $originalContent -replace 'cmake_minimum_required\(VERSION [0-9]+\.[0-9]+(?:\.[0-9]+)?\)', 'cmake_minimum_required(VERSION 3.5)'
          if ($patchedContent -ne $originalContent) {
            Set-Content CMakeLists.txt $patchedContent
            Write-Host "Successfully patched CMakeLists.txt to require CMake 3.5+"
          } else {
            Write-Host "Warning: CMakeLists.txt patch pattern not found, continuing anyway..."
          }
          
          cmake -S . -B build `
            -DCMAKE_INSTALL_PREFIX=C:\olm-install `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release
          cmake --install build --config Release
          
          # Debug: Show what files were created
          Write-Host "Contents of C:\olm-install\lib:"
          Get-ChildItem -Path C:\olm-install\lib -Recurse
          
          # Verify that libolm was built (either olm.lib or olm_static.lib)
          if (-not (Test-Path "C:\olm-install\lib\olm.lib") -and -not (Test-Path "C:\olm-install\lib\olm_static.lib")) {
            Write-Error "ERROR: Neither olm.lib nor olm_static.lib found in C:\olm-install\lib. Build cannot continue."
            exit 1
          }
          Write-Host "libolm library built successfully"
          
          # Set environment variables for python-olm build
          # Include both the include and lib paths, and also set CMAKE_PREFIX_PATH for FindOlm
          echo "INCLUDE=C:\olm-install\include;$env:INCLUDE" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "LIB=C:\olm-install\lib;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CMAKE_PREFIX_PATH=C:\olm-install;$env:CMAKE_PREFIX_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Update version in files
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python3 -c "
          import re
          version = '$VERSION'
          with open('chatrixcd/__init__.py', 'r') as f:
              content = f.read()
          content = re.sub(r'__version__ = \".*\"', f'__version__ = \"{version}\"', content)
          with open('chatrixcd/__init__.py', 'w') as f:
              f.write(content)
          print(f'Updated version to {version}')
          "
      
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: chatrixcd/main.py
          mode: onefile
          output-file: chatrixcd-windows-${{ matrix.arch }}.exe
          enable-plugins: anti-bloat
          assume-yes-for-downloads: true
          company-name: "ChatrixCD Contributors"
          product-name: "ChatrixCD"
          file-version: ${{ steps.version.outputs.version }}
          product-version: ${{ steps.version.outputs.version }}
          file-description: "Matrix bot for CI/CD automation with Semaphore UI"
          copyright: "Copyright (c) 2024 ChatrixCD Contributors"
          windows-icon-from-ico: assets/icon.ico
          onefile-tempdir-spec: "%TEMP%\\chatrixcd"
          windows-console-mode: force
          include-data-dir: assets=assets
      
      - name: Verify build and show evidence
        shell: bash
        run: |
          BINARY="chatrixcd-windows-${{ matrix.arch }}.exe"
          if [ -f "$BINARY" ]; then
            echo "========================================="
            echo "✅ Build successful for Windows ${{ matrix.arch }}"
            echo "========================================="
            ls -lh "$BINARY"
            echo ""
            echo "SHA256 Checksum:"
            sha256sum "$BINARY"
            echo ""
            echo "File Size: $(stat -c%s "$BINARY") bytes ($(ls -lh "$BINARY" | awk '{print $5}'))"
            echo "========================================="
          else
            echo "❌ Build failed - binary not found"
            exit 1
          fi

  build-macos:
    name: Build macOS Universal
    needs: test
    runs-on: macos-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all tags
        run: git fetch --tags --force
      
      - name: Calculate version
        id: version
        shell: bash
        run: |
          # Use test version for test builds
          VERSION="test-$(date +%Y%m%d-%H%M%S)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install build dependencies (macOS)
        run: |
          # Install libolm and cmake from homebrew to avoid building from source
          brew install libolm pkg-config cmake
      
      - name: Set PKG_CONFIG_PATH for subsequent steps
        run: |
          # Detect homebrew prefix (Apple Silicon uses /opt/homebrew, Intel uses /usr/local)
          HOMEBREW_PREFIX=$(brew --prefix)
          
          # Set environment variables for subsequent steps
          {
            echo "PKG_CONFIG_PATH=${HOMEBREW_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
            echo "CFLAGS=-I${HOMEBREW_PREFIX}/include"
            echo "LDFLAGS=-L${HOMEBREW_PREFIX}/lib"
          } >> "$GITHUB_ENV"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Update version in files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python3 -c "
          import re
          version = '$VERSION'
          with open('chatrixcd/__init__.py', 'r') as f:
              content = f.read()
          content = re.sub(r'__version__ = \".*\"', f'__version__ = \"{version}\"', content)
          with open('chatrixcd/__init__.py', 'w') as f:
              f.write(content)
          print(f'Updated version to {version}')
          "
      
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: chatrixcd/main.py
          mode: onefile
          output-file: chatrixcd-macos-universal
          enable-plugins: anti-bloat
          assume-yes-for-downloads: true
          macos-create-app-bundle: true
          macos-app-icon: assets/icon.png
          macos-app-name: "ChatrixCD"
          macos-app-version: ${{ steps.version.outputs.version }}
          macos-target-arch: universal2
          include-data-dir: assets=assets
      
      - name: Verify build and show evidence
        run: |
          echo "========================================="
          echo "macOS Universal Build Verification"
          echo "========================================="
          
          # Check for binary
          BINARY="chatrixcd-macos-universal"
          if [ -f "$BINARY" ]; then
            echo ""
            echo "✅ Standalone binary build successful"
            ls -lh "$BINARY"
            echo ""
            echo "SHA256 Checksum:"
            shasum -a 256 "$BINARY"
            echo ""
            echo "File Size: $(stat -f%z "$BINARY") bytes ($(ls -lh "$BINARY" | awk '{print $5}'))"
          else
            echo "⚠️  Standalone binary not found"
          fi
          
          echo ""
          echo "========================================="
          
          # Check for app bundle
          if [ -d "ChatrixCD.app" ]; then
            echo ""
            echo "✅ App bundle build successful"
            du -sh ChatrixCD.app
            echo ""
            echo "App bundle contents (first 10 files with checksums):"
            find ChatrixCD.app -type f | head -10 | while read file; do
              echo "  $(shasum -a 256 "$file")"
            done
            echo ""
            echo "App bundle size: $(du -sh ChatrixCD.app | awk '{print $1}')"
          else
            echo "❌ App bundle not found"
            exit 1
          fi
          
          echo "========================================="

  # Summary job to show all results
  summary:
    name: Build Summary
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Display results
        run: |
          echo "========================================="
          echo "Build Test Results Summary"
          echo "========================================="
          echo ""
          echo "This test workflow verifies that all binaries can be built successfully."
          echo "Artifacts are NOT published - they are discarded after verification."
          echo ""
          echo "Check the logs of each build job above for:"
          echo "  - Binary file sizes"
          echo "  - SHA256 checksums"
          echo "  - Build success confirmation"
          echo ""
          echo "If all jobs passed, the build process is working correctly."
          echo "========================================="
