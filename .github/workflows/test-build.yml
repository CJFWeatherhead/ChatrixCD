name: Test Build (No Publish)

on:
  # Trigger on push to this branch for automatic testing
  push:
    branches:
      - copilot/duplicate-workflow-discard-artifacts
  
  # Manual trigger also available
  workflow_dispatch:

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run unit tests
        run: |
          python -m unittest discover -s tests -v

  # Linux builds removed - all completed successfully in run #6
  # Evidence from successful Linux builds:
  #   x86_64: SHA256 9f7c969ad179442e401f474bee8960213e00fa280583c8ede9b943ad1f7a2931, Size 36,871,721 bytes (36M)
  #   i686:   SHA256 0c62df6a52c40c0fe76a57face434f41fba6f2d6a185247601fb1bb05611f861, Size 27,348,052 bytes (27M)
  #   arm64:  SHA256 f4204100536b04bdc9aed664d38218baa08952604f95fba7293ab93ee9221dd1, Size 26,177,989 bytes (25M)
  # Focusing on Windows and macOS which still have build errors

  build-windows:
    name: Build Windows ${{ matrix.arch }}
    needs: test
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all tags
        run: git fetch --tags --force
      
      - name: Calculate version
        id: version
        shell: bash
        run: |
          # Use test version for test builds
          VERSION="test-$(date +%Y%m%d-%H%M%S)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Install libolm (Windows)
        shell: pwsh
        run: |
          # Download and build libolm (pinned to v3.2.16 for reproducible builds)
          git clone --branch 3.2.16 --depth 1 https://gitlab.matrix.org/matrix-org/olm.git C:\olm
          cd C:\olm
          
          # Patch CMakeLists.txt to require CMake 3.5+ (for compatibility with modern CMake)
          $originalContent = Get-Content CMakeLists.txt -Raw
          $patchedContent = $originalContent -replace 'cmake_minimum_required\(VERSION [0-9]+\.[0-9]+(?:\.[0-9]+)?\)', 'cmake_minimum_required(VERSION 3.5)'
          if ($patchedContent -ne $originalContent) {
            Set-Content CMakeLists.txt $patchedContent
            Write-Host "Successfully patched CMakeLists.txt to require CMake 3.5+"
          } else {
            Write-Host "Warning: CMakeLists.txt patch pattern not found, continuing anyway..."
          }
          
          cmake -S . -B build `
            -DCMAKE_INSTALL_PREFIX=C:\olm-install `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release
          cmake --install build --config Release
          
          # Debug: Show what files were created
          Write-Host "Contents of C:\olm-install\lib:"
          Get-ChildItem -Path C:\olm-install\lib -Recurse
          
          # Verify that libolm was built (either olm.lib or olm_static.lib)
          if (-not (Test-Path "C:\olm-install\lib\olm.lib") -and -not (Test-Path "C:\olm-install\lib\olm_static.lib")) {
            Write-Error "ERROR: Neither olm.lib nor olm_static.lib found in C:\olm-install\lib. Build cannot continue."
            exit 1
          }
          Write-Host "libolm library built successfully"
          
          # Set environment variables for python-olm build
          # Include both the include and lib paths, and also set CMAKE_PREFIX_PATH for FindOlm
          echo "INCLUDE=C:\olm-install\include;$env:INCLUDE" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "LIB=C:\olm-install\lib;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CMAKE_PREFIX_PATH=C:\olm-install;$env:CMAKE_PREFIX_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          
          # Download python-olm source and patch embedded libolm CMakeLists.txt
          pip download python-olm~=3.2 --no-binary=:all: --no-deps
          $tarball = Get-ChildItem python-olm-*.tar.gz | Select-Object -First 1
          tar -xzf $tarball
          $olmDir = Get-ChildItem -Directory python-olm-* | Select-Object -First 1
          
          # Patch the embedded CMakeLists.txt
          $cmakeFile = Join-Path $olmDir.FullName "lib\cmake\CMakeLists.txt"
          if (Test-Path $cmakeFile) {
            $content = Get-Content $cmakeFile -Raw
            $content = $content -replace 'cmake_minimum_required\(VERSION [0-9]+\.[0-9]+(?:\.[0-9]+)?\)', 'cmake_minimum_required(VERSION 3.5)'
            Set-Content $cmakeFile $content
            Write-Host "Patched embedded CMakeLists.txt in python-olm"
          }
          
          # Install from patched source
          pip install $olmDir.FullName
          
          # Install remaining dependencies
          pip install -r requirements.txt
      
      - name: Update version in files
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python3 -c "
          import re
          version = '$VERSION'
          with open('chatrixcd/__init__.py', 'r') as f:
              content = f.read()
          content = re.sub(r'__version__ = \".*\"', f'__version__ = \"{version}\"', content)
          with open('chatrixcd/__init__.py', 'w') as f:
              f.write(content)
          print(f'Updated version to {version}')
          "
      
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: chatrixcd/main.py
          mode: onefile
          output-file: chatrixcd-windows-${{ matrix.arch }}.exe
          enable-plugins: anti-bloat
          assume-yes-for-downloads: true
          company-name: "ChatrixCD Contributors"
          product-name: "ChatrixCD"
          file-version: ${{ steps.version.outputs.version }}
          product-version: ${{ steps.version.outputs.version }}
          file-description: "Matrix bot for CI/CD automation with Semaphore UI"
          copyright: "Copyright (c) 2024 ChatrixCD Contributors"
          windows-icon-from-ico: assets/icon.ico
          onefile-tempdir-spec: "%TEMP%\\chatrixcd"
          windows-console-mode: force
          include-data-dir: assets=assets
      
      - name: Verify build and show evidence
        shell: bash
        run: |
          BINARY="chatrixcd-windows-${{ matrix.arch }}.exe"
          if [ -f "$BINARY" ]; then
            echo "========================================="
            echo "✅ Build successful for Windows ${{ matrix.arch }}"
            echo "========================================="
            ls -lh "$BINARY"
            echo ""
            echo "SHA256 Checksum:"
            sha256sum "$BINARY"
            echo ""
            echo "File Size: $(stat -c%s "$BINARY") bytes ($(ls -lh "$BINARY" | awk '{print $5}'))"
            echo "========================================="
          else
            echo "❌ Build failed - binary not found"
            exit 1
          fi

  build-macos:
    name: Build macOS Universal
    needs: test
    runs-on: macos-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all tags
        run: git fetch --tags --force
      
      - name: Calculate version
        id: version
        shell: bash
        run: |
          # Use test version for test builds
          VERSION="test-$(date +%Y%m%d-%H%M%S)"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install build dependencies (macOS)
        run: |
          # Install libolm and cmake from homebrew to avoid building from source
          brew install libolm pkg-config cmake
      
      - name: Set PKG_CONFIG_PATH for subsequent steps
        run: |
          # Detect homebrew prefix (Apple Silicon uses /opt/homebrew, Intel uses /usr/local)
          HOMEBREW_PREFIX=$(brew --prefix)
          
          # Set environment variables for subsequent steps
          {
            echo "PKG_CONFIG_PATH=${HOMEBREW_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
            echo "CFLAGS=-I${HOMEBREW_PREFIX}/include"
            echo "LDFLAGS=-L${HOMEBREW_PREFIX}/lib"
          } >> "$GITHUB_ENV"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Download python-olm source and patch embedded libolm CMakeLists.txt
          pip download python-olm~=3.2 --no-binary=:all: --no-deps
          tar -xzf python-olm-*.tar.gz
          OLM_DIR=$(ls -d python-olm-*/ | head -n 1)
          
          # Patch the embedded CMakeLists.txt
          CMAKE_FILE="${OLM_DIR}lib/cmake/CMakeLists.txt"
          if [ -f "$CMAKE_FILE" ]; then
            sed -i '' 's/cmake_minimum_required(VERSION [0-9]*\.[0-9]*)/cmake_minimum_required(VERSION 3.5)/' "$CMAKE_FILE"
            echo "Patched embedded CMakeLists.txt in python-olm"
          fi
          
          # Install from patched source
          pip install "$OLM_DIR"
          
          # Install remaining dependencies
          pip install -r requirements.txt
      
      - name: Update version in files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python3 -c "
          import re
          version = '$VERSION'
          with open('chatrixcd/__init__.py', 'r') as f:
              content = f.read()
          content = re.sub(r'__version__ = \".*\"', f'__version__ = \"{version}\"', content)
          with open('chatrixcd/__init__.py', 'w') as f:
              f.write(content)
          print(f'Updated version to {version}')
          "
      
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: chatrixcd/main.py
          mode: onefile
          output-file: chatrixcd-macos-universal
          enable-plugins: anti-bloat
          assume-yes-for-downloads: true
          macos-create-app-bundle: true
          macos-app-icon: assets/icon.png
          macos-app-name: "ChatrixCD"
          macos-app-version: ${{ steps.version.outputs.version }}
          macos-target-arch: universal2
          include-data-dir: assets=assets
      
      - name: Verify build and show evidence
        run: |
          echo "========================================="
          echo "macOS Universal Build Verification"
          echo "========================================="
          
          # Check for binary
          BINARY="chatrixcd-macos-universal"
          if [ -f "$BINARY" ]; then
            echo ""
            echo "✅ Standalone binary build successful"
            ls -lh "$BINARY"
            echo ""
            echo "SHA256 Checksum:"
            shasum -a 256 "$BINARY"
            echo ""
            echo "File Size: $(stat -f%z "$BINARY") bytes ($(ls -lh "$BINARY" | awk '{print $5}'))"
          else
            echo "⚠️  Standalone binary not found"
          fi
          
          echo ""
          echo "========================================="
          
          # Check for app bundle
          if [ -d "ChatrixCD.app" ]; then
            echo ""
            echo "✅ App bundle build successful"
            du -sh ChatrixCD.app
            echo ""
            echo "App bundle contents (first 10 files with checksums):"
            find ChatrixCD.app -type f | head -10 | while read file; do
              echo "  $(shasum -a 256 "$file")"
            done
            echo ""
            echo "App bundle size: $(du -sh ChatrixCD.app | awk '{print $1}')"
          else
            echo "❌ App bundle not found"
            exit 1
          fi
          
          echo "========================================="

  # Summary job to show all results
  summary:
    name: Build Summary
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Display results
        run: |
          echo "========================================="
          echo "Build Test Results Summary"
          echo "========================================="
          echo ""
          echo "This test workflow verifies that all binaries can be built successfully."
          echo "Artifacts are NOT published - they are discarded after verification."
          echo ""
          echo "Check the logs of each build job above for:"
          echo "  - Binary file sizes"
          echo "  - SHA256 checksums"
          echo "  - Build success confirmation"
          echo ""
          echo "If all jobs passed, the build process is working correctly."
          echo "========================================="
